# -*- coding: utf-8 -*-
# Generated by Django 1.11.16 on 2018-11-20 13:12
from __future__ import unicode_literals

from django.db import migrations


def fill_order_item(Resource, obj, order_item):
    if not hasattr(order_item, 'scope'):
        return
    resource, _ = Resource.objects.get_or_create(
        scope=order_item.scope,
        plan=order_item.plan,
        attributes=order_item.attributes,
        offering=order_item.offering,
    )
    obj.resource = resource
    obj.save()


def migrate_resource(apps, schema_editor):
    Resource = apps.get_model('marketplace', 'Resource')

    OrderItem = apps.get_model('marketplace', 'OrderItem')
    for obj in OrderItem.objects.all():
        fill_order_item(Resource, obj, obj)

    ComponentQuota = apps.get_model('marketplace', 'ComponentQuota')
    for obj in ComponentQuota.objects.all():
        fill_order_item(Resource, obj, obj.order_item)

    ComponentUsage = apps.get_model('marketplace', 'ComponentUsage')
    for obj in ComponentUsage.objects.all():
        fill_order_item(Resource, obj, obj.order_item)


class Migration(migrations.Migration):

    dependencies = [
        ('marketplace', '0045_add_resource'),
    ]

    operations = [
        migrations.RunPython(migrate_resource)
    ]
