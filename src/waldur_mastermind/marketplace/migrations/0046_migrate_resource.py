# -*- coding: utf-8 -*-
# Generated by Django 1.11.16 on 2018-11-20 13:12
from __future__ import unicode_literals

from django.db import migrations


def fill_resources(Resource, queryset):
    for obj in queryset:
        order_item = obj.order_item
        if not hasattr(order_item, 'scope'):
            continue
        resource, _ = Resource.objects.get_or_create(
            scope=order_item.scope,
            plan=order_item.plan,
            attributes=order_item.attributes,
        )
        obj.resource = resource
        obj.save()


def migrate_resource(apps, schema_editor):
    ComponentQuota = apps.get_model('marketplace', 'ComponentQuota')
    ComponentUsage = apps.get_model('marketplace', 'ComponentUsage')
    Resource = apps.get_model('marketplace', 'Resource')

    fill_resources(Resource, ComponentQuota.objects.all())
    fill_resources(Resource, ComponentUsage.objects.all())


class Migration(migrations.Migration):

    dependencies = [
        ('marketplace', '0045_add_resource'),
    ]

    operations = [
        migrations.RunPython(migrate_resource)
    ]
